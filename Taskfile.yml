version: '3'

tasks:
  default:
    cmds:
    - task: install

  pull:
    desc: Pull latest changes from VCS
    cmds:
      - git pull --rebase --force

  install:
    desc: Install dependencies
    deps:
      - pull
    sources:
      - package.json
    generates:
      - bun.lock
    cmds:
      - bun install --frozen-lockfile

  build:
    desc: Build GitHub Action
    sources:
      - bin/**/*.ts
      - src/**/*.ts
    generates:
      - dist/index.js
    cmds:
      - >
        bun build bin/index.ts
        --production
        --target node
        --outdir dist
        --format esm

  clean:
    desc: Clean build artifacts
    cmds:
      - rm -rf dist/

  test:
    desc: Run unit tests
    cmds:
      - bun test --coverage {{ .CLI_ARGS }}

  test:watch:
    desc: Run tests in watch mode
    cmd:
      task: test
      vars:
        CLI_ARGS: --watch

  test:mutation:
    desc: Run mutation tests with StrykerJS
    cmds:
      - bunx stryker run

  lint:
    desc: Lint code with Biome
    cmds:
      - bunx @biomejs/biome check .

  format:
    desc: Format code with Biome
    cmds:
      - bunx @biomejs/biome check --write .
